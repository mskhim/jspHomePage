package co.kh.dev.home.action.shop;

import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;

import co.kh.dev.home.action.Action;
import co.kh.dev.home.control.ActionForward;
import co.kh.dev.home.model.ShopDAO;
import co.kh.dev.home.model.ShopImgDAO;
import co.kh.dev.home.model.ShopImgVO;
import co.kh.dev.home.model.ShopVO;

@MultipartConfig
(fileSizeThreshold = 1024 * 1024 * 2, // 2MB
		maxFileSize = 1024 * 1024 * 10, // 10MB
		maxRequestSize = 1024 * 1024 * 50 // 50MB
)
public class ShopInsertAction implements Action {
	private static final String UPLOAD_DIRECTORY = "uploads";

	@Override
	public ActionForward execute(HttpServletRequest request, HttpServletResponse response) throws IOException {
		// 업로드 경로 설정
		System.out.println("Content-Type: " + request.getContentType());
		if (request.getContentType() != null && request.getContentType().startsWith("multipart/")) {
		    System.out.println("This is a multipart request.");
		} else {
		    System.out.println("This is NOT a multipart request.");
		}
		String title = null;
		String content = null;
		int productNo = 0;
		ShopVO svo = new ShopVO();
		ShopDAO sDAO = ShopDAO.getInstance();
		ShopImgDAO siDAO = ShopImgDAO.getInstance();
		try {
			for (Part part : request.getParts()) {
				if (part.getName().equals("title")) { // 텍스트 데이터
					title = new String(part.getInputStream().readAllBytes(), StandardCharsets.UTF_8);
				} else if (part.getName().equals("content")) { // 텍스트 데이터
					content = new String(part.getInputStream().readAllBytes(), StandardCharsets.UTF_8);
				} else if (part.getName().equals("productNo")) { // 파일 데이터
					productNo = Integer.parseInt(new String(part.getInputStream().readAllBytes(), StandardCharsets.UTF_8));
				}
			}
		} catch (NumberFormatException | IOException | ServletException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
			svo = new ShopVO(Integer.parseInt(request.getParameter("type")), productNo, title, content);
			sDAO.insertDB(svo);
			svo = sDAO.selectLastDB();
			String uploadPath = request.getServletContext().getRealPath("") + File.separator + UPLOAD_DIRECTORY;
			File uploadDir = new File(uploadPath);
			if (!uploadDir.exists()) {
				uploadDir.mkdir();
			}
			// 파일 저장 처리
			int contentFileIndex = 1; // CONTENT 파일 순서
			int titleFileIndex = 1; // TITLE 파일 순서
			try {
				for (Part part : request.getParts()) {
				if (part.getName().equals("contentImgs")) { // 다중 파일 (CONTENT)
					String fileName = svo.getNo() + "_content_" + contentFileIndex + "_" + extractFileName(part);
					String filePath = uploadPath + File.separator + fileName;
					ShopImgVO sivo = new ShopImgVO("CONTENT", svo.getNo(), filePath);
					siDAO.insertDB(sivo); // DB에 삽입
					part.write(filePath); // 파일 저장
					contentFileIndex++;
				} else if (part.getName().equals("titleImg")) { // 단일 파일 (TITLE)
					String fileName = svo.getNo() + "_title_" + titleFileIndex + "_" + extractFileName(part);
					String filePath = uploadPath + File.separator + fileName;
					ShopImgVO sivo = new ShopImgVO("TITLE", svo.getNo(), filePath);
					siDAO.insertDB(sivo); // DB에 삽입
					part.write(filePath); // 파일 저장
					titleFileIndex++;
				}
}
			} catch (IOException | ServletException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}

		ActionForward forward = new ActionForward("/shopSelect.do?type=" + svo.getType(), false);
		return forward;
	}

	private String extractFileName(Part part) {
		String contentDisp = part.getHeader("content-disposition");
		for (String content : contentDisp.split(";")) {
			if (content.trim().startsWith("filename")) {
				return content.substring(content.indexOf("=") + 2, content.length() - 1); // 파일명 추출
			}
		}
		return "unknown"; // 파일명이 없으면 기본값
	}
}
